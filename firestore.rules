rules_version = '2';
service cloud.firestore {

  function hasAuth() { return request.auth != null; }

  // Acepta cualquiera de los nombres de claim: orgId, org, org_id
  function claimOrg() {
    return hasAuth()
      ? (request.auth.token.orgId != null ? request.auth.token.orgId
        : request.auth.token.org     != null ? request.auth.token.org
        : request.auth.token.org_id  != null ? request.auth.token.org_id
        : null)
      : null;
  }

  function sameUser(uid)        { return hasAuth() && request.auth.uid == uid; }
  function sameOrgWrite()       { return hasAuth() && request.resource.data.orgId == claimOrg(); }
  function sameOrgRead(orgId)   { return hasAuth() && orgId == claimOrg(); }

  match /databases/{database}/documents {

    // ===== App base =====
    match /inventoryItems/{doc} {
      allow read: if true; // (en prod podrías endurecer con sameOrgRead(resource.data.orgId))
      allow create, update, delete: if sameOrgWrite();
    }

    match /builderConfigs/{org} {
      allow read: if true;
      allow create, update: if hasAuth() && org == claimOrg();
      allow delete: if false;
    }

    match /presets/{doc} {
      allow read: if true;
      allow create, update, delete: if sameOrgWrite();
    }

    // Órdenes: el cliente puede crear la suya, y leer la suya;
    // apps de la misma org pueden leer (p.ej. worker).
    match /orders/{doc} {
      allow create: if sameOrgWrite() && sameUser(request.resource.data.userId);
      allow read: if sameUser(resource.data.userId) || sameOrgRead(resource.data.orgId);
      allow update, delete: if false;
    }

    // ===== Perfil (doc por UID) =====
    match /profiles/{uid} {
      allow read: if true;                   // abre lectura (útil en DEV)
      allow create, update: if sameUser(uid);
      allow delete: if false;
    }

    // ===== Fidelización =====
    match /loyaltyProfiles/{uid} {
      allow read: if sameUser(uid);
      allow create, update: if sameUser(uid);
      allow delete: if false;
    }

    // Estructura: loyaltyMovements/{uid}/items/{mov}
    match /loyaltyMovements/{uid}/items/{mov} {
      allow read: if sameUser(uid);
      allow create: if sameUser(uid);
      allow update, delete: if false;
    }

    // ===== Cola para el worker =====
    // Escribes desde el cliente: orgs/{orgId}/workQueue/{jobId}
    match /orgs/{orgId}/workQueue/{jobId} {
      allow read: if sameOrgRead(orgId);
      allow create: if hasAuth()
        && orgId == claimOrg()
        && request.resource.data.orgId == orgId
        && request.resource.data.orderId is string
        && request.resource.data.status in ['queued']; // sólo alta en cola
      allow update, delete: if false; // cambios posteriores por backend admin SDK/CF
    }

    // Fallback de lectura abierta en DEV; no permite escrituras fuera de lo anterior.
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}
