import { doc, setDoc, updateDoc, serverTimestamp, collection, getDoc } from "firebase/firestore";
import { db } from "@/services/firebase";

/** Usa VITE_ORG_ID si existe; si no, 'default' */
const ORG_ID = import.meta.env.VITE_ORG_ID ?? "default";

/** YYYY-MM-DD */
function ymd(d = new Date()) {
  return d.toISOString().slice(0, 10);
}

/** Apertura del dÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a por usuario (id = YYYY-MM-DD_uid) */
export async function openDay(params: {
  initialCash: number;
  tasksDone: string[];
  photoDataUrl?: string | null;
  userId?: string | null;
}) {
  const { initialCash, tasksDone, photoDataUrl, userId } = params;

  if (!userId) throw new Error("Falta userId (sesiÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n)");
  // Las reglas piden las 2 confirmaciones de WhatsApp
  const must = ["foto_wpp_sent", "foto_wpp_double"];
  const hasBoth = must.every((k) => tasksDone.includes(k));
  if (!hasBoth) throw new Error("Faltan las 2 confirmaciones de WhatsApp en el checklist");

  const id = `${ymd()}_${userId}`;
  const ref = doc(collection(db, "openings"), id);
  const prev = await getDoc(ref);

  await setDoc(ref, {
    id,
    orgId: ORG_ID,
    dateKey: ymd(),
    userId,
    initialCash: Number(initialCash) || 0,
    tasksDone,
    status: "open",
    createdAt: prev.exists() ? prev.data()?.createdAt ?? serverTimestamp() : serverTimestamp(),
  }, { merge: true });

  // (Opcional) Si usas foto dentro del doc; reglas no la requieren.
  if (photoDataUrl) {
    await updateDoc(ref, { photoDataUrl });
  }

  return { id };
}
