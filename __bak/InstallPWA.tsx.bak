import { useEffect, useMemo, useState } from "react";

declare global {
  interface Window {
    __PWA__?: { deferred: BeforeInstallPromptEvent | null };
  }
}

/** Tipo no estándar para TS */
interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: "accepted" | "dismissed"; platform: string }>;
}

export default function InstallPWA() {
  const [deferred, setDeferred] = useState<BeforeInstallPromptEvent | null>(null);
  const [installed, setInstalled] = useState(false);
  const [swReady, setSwReady] = useState<boolean>(() => !!navigator.serviceWorker?.controller);
  const [debug, setDebug] = useState<string>("");

  // Hidrata si el index.html guardó el evento antes del mount
  const hydrateDeferred = () => {
    const d = window.__PWA__?.deferred ?? null;
    if (d && !deferred) setDeferred(d);
  };

  useEffect(() => {
    const onBIP = (e: Event) => {
      // MUY IMPORTANTE: prevenir el banner y quedarnos con el evento
      e.preventDefault?.();
      setDeferred(e as BeforeInstallPromptEvent);
    };
    const onInstalled = () => {
      setInstalled(true);
      setDeferred(null);
      if (window.__PWA__) window.__PWA__.deferred = null;
    };
    const onCtrlChange = () => setSwReady(!!navigator.serviceWorker?.controller);
    const onDeferredReady = () => hydrateDeferred();

    window.addEventListener("beforeinstallprompt", onBIP as any);
    window.addEventListener("appinstalled", onInstalled);
    window.addEventListener("pwa:deferred-ready", onDeferredReady);
    navigator.serviceWorker?.addEventListener?.("controllerchange", onCtrlChange);

    hydrateDeferred();

    // SW status (el registro lo hace src/main.tsx)
    navigator.serviceWorker?.ready
      ?.then(() => {
        setSwReady(!!navigator.serviceWorker?.controller);
        setDebug("SW listo");
      })
      .catch(() => {});

    return () => {
      window.removeEventListener("beforeinstallprompt", onBIP as any);
      window.removeEventListener("appinstalled", onInstalled);
      window.removeEventListener("pwa:deferred-ready", onDeferredReady);
      navigator.serviceWorker?.removeEventListener?.("controllerchange", onCtrlChange);
    };
  }, []);

  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone =
    (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
    (navigator as any).standalone === true;

  const canInstall = !!deferred && !installed && !isStandalone && !isIOS;

  const reason = useMemo(() => {
    if (installed) return "Ya está instalada.";
    if (isStandalone) return "Ya estás usando la app instalada.";
    if (!swReady) return "El Service Worker aún no controla esta pestaña.";
    return "Esperando a que el navegador permita la instalación…";
  }, [installed, isStandalone, swReady]);

  const install = async () => {
    const d = deferred || window.__PWA__?.deferred || null;
    if (!d) {
      alert("Si tu navegador lo permite, usa 'Añadir a pantalla de inicio'.");
      return;
    }
    try {
      await d.prompt();
      const { outcome } = await d.userChoice;
      if (outcome === "accepted") {
        // El evento 'appinstalled' terminará de actualizar estados
      }
    } catch (e) {
      console.error(e);
      alert("No se pudo iniciar la instalación.");
    } finally {
      setDeferred(null);
      if (window.__PWA__) window.__PWA__.deferred = null;
    }
  };

  return (
    <div className="rounded-2xl border bg-white p-4 space-y-2">
      <div className="font-semibold">Aplicación</div>

      {isIOS ? (
        <p className="text-sm text-slate-600">
          En iPhone, toca <strong>Compartir</strong> → <strong>Añadir a pantalla de inicio</strong>.
        </p>
      ) : (
        <>
          <p className="text-sm text-slate-600">
            {canInstall ? "Puedes instalar la app." : reason}
          </p>

          <div className="flex gap-2">
            <button
              className="btn btn-primary px-3 py-2 rounded-xl"
              onClick={install}
              disabled={!canInstall}
              title={!canInstall ? "El navegador aún no expuso el diálogo" : "Instalar app"}
            >
              Instalar
            </button>

            {!swReady && (
              <span className="text-xs text-slate-500 self-center">
                Esperando al Service Worker…
              </span>
            )}
          </div>

          {swReady && !canInstall && !installed && !isStandalone && (
            <div className="text-xs text-slate-500">
              Si no aparece el diálogo, en Chrome abre el menú <b>⋮</b> y pulsa <b>Instalar app</b>.
            </div>
          )}

          {debug && <div className="text-[11px] text-slate-400">PWA: {debug}</div>}
        </>
      )}
    </div>
  );
}
