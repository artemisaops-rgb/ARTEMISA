rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    function isLoggedIn() { return request.auth != null; }

    function orgOf() {
      return (resource.data.orgId != null)
        ? resource.data.orgId
        : request.resource.data.orgId;
    }

    function isMember(orgId) {
      return isLoggedIn() &&
        exists(/databases/$(db)/documents/orgs/$(orgId)/members/$(request.auth.uid));
    }
    function role(orgId) {
      return get(/databases/$(db)/documents/orgs/$(orgId)/members/$(request.auth.uid)).data.role;
    }
    function isStaff(orgId) {
      let r = role(orgId);
      return r == "worker" || r == "owner";
    }
    function isOwner(orgId) { return role(orgId) == "owner"; }

    function customerOrg(uid) {
      return get(/databases/$(db)/documents/customers/$(uid)).data.orgId;
    }

    match /orgs/{orgId}/members/{uid} {
      allow read:   if isLoggedIn() && (request.auth.uid == uid || isOwner(orgId));
      allow write:  if isLoggedIn() && (request.auth.uid == uid || isOwner(orgId));
    }

    match /customers/{uid} {
      allow read:   if (isLoggedIn() && request.auth.uid == uid) || isMember(orgOf());
      allow create: if isLoggedIn() && request.auth.uid == uid;
      allow update: if isLoggedIn() && (request.auth.uid == uid || isStaff(orgOf()));
      allow delete: if isOwner(orgOf());

      match /loyaltyEvents/{eventId} {
        allow read:   if (isLoggedIn() && request.auth.uid == uid) || isMember(orgOf());
        allow create: if isStaff(orgOf()) && request.resource.data.orgId == customerOrg(uid);
        allow update, delete: if false;
      }
    }

    match /schedules/{uid}/{document=**} {
      allow read, write: if isLoggedIn() && request.auth.uid == uid;
    }

    match /{colName}/{docId} {
      allow read:  if (colName in [
                      "orders","products","inventoryItems","stockMovements",
                      "openings","cashMovements","dailySummary","horarios","exports"
                    ]) && isMember(orgOf());
      allow write: if (colName in [
                      "orders","products","inventoryItems","stockMovements",
                      "openings","cashMovements","dailySummary","horarios","exports"
                    ]) && isStaff(orgOf());
    }
  }
}
